<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.128.1">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Routing API với Kong Gateway :: Create a new AWS account.</title>

    
    <link href="/css/nucleus.css?1753536349" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1753536349" rel="stylesheet">
    <link href="/css/hybrid.css?1753536349" rel="stylesheet">
    <link href="/css/featherlight.min.css?1753536349" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1753536349" rel="stylesheet">
    <link href="/css/auto-complete.css?1753536349" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1753536349" rel="stylesheet">
    <link href="/css/theme.css?1753536349" rel="stylesheet">
    <link href="/css/hugo-theme.css?1753536349" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1753536349" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1753536349"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/6-enabling-batch-processing-in-lambda-with-sqs/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1753536349"></script>
<script type="text/javascript" src="/js/auto-complete.js?1753536349"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1753536349"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-creating-networking-resource-aws/" title="Tạo tài nguyên mạng AWS" class="dd-item 
        
        
        
        ">
      <a href="/1-creating-networking-resource-aws/">
           <b> 1 </b> Tạo tài nguyên mạng AWS
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-creating-first-applications-at-ps/" title="Xây dựng các ứng dụng đầu tiên ở Public Subnet" class="dd-item 
        
        
        
        ">
      <a href="/2-creating-first-applications-at-ps/">
           <b> 2 </b> Xây dựng các ứng dụng đầu tiên ở Public Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-creating-database-at-pds/" title="Tạo các database ở Private Database Subnet" class="dd-item 
        
        
        
        ">
      <a href="/3-creating-database-at-pds/">
           <b> 3 </b> Tạo các database ở Private Database Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-creating-resources-at-pms/" title="Tạo các tài nguyên ở Private Middleware Subnet" class="dd-item 
        
        
        
        ">
      <a href="/4-creating-resources-at-pms/">
           <b> 4 </b> Tạo các tài nguyên ở Private Middleware Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-creating-resources-at-pas/" title="Tạo các tài nguyên ở Private Application Subnet" class="dd-item 
        
        
        
        ">
      <a href="/5-creating-resources-at-pas/">
           <b> 5 </b> Tạo các tài nguyên ở Private Application Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-enabling-batch-processing-in-lambda-with-sqs/" title="Routing API với Kong Gateway" class="dd-item 
        
        active
        
        ">
      <a href="/6-enabling-batch-processing-in-lambda-with-sqs/">
           <b> 6 </b> Routing API với Kong Gateway
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/7-setting-up-monitoring-and-logging-with-cloudwatch/" title="Monitoring and Observability with Amazon CloudWatch" class="dd-item 
        
        
        
        ">
      <a href="/7-setting-up-monitoring-and-logging-with-cloudwatch/">
           <b> 7. </b> Monitoring and Observability with Amazon CloudWatch
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/8-optimizing-for-cost-and-performance-in-event-flows/" title="Optimizing for Cost and Performance in Event Flows" class="dd-item 
        
        
        
        ">
      <a href="/8-optimizing-for-cost-and-performance-in-event-flows/">
           <b> 8. </b> Optimizing for Cost and Performance in Event Flows
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/9-documenting-operational-procedures-and-recovery-steps/" title="Thực hiện các API của ứng dụng Backend" class="dd-item 
        
        
        
        ">
      <a href="/9-documenting-operational-procedures-and-recovery-steps/">
           <b> 9. </b> Thực hiện các API của ứng dụng Backend
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/10-building-a-testing-framework-for-event-driven-workflows/" title="Building a Testing Framework for Event-Driven Workflows" class="dd-item 
        
        
        
        ">
      <a href="/10-building-a-testing-framework-for-event-driven-workflows/">
           <b> 10. </b> Building a Testing Framework for Event-Driven Workflows
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://aws.amazon.com/blogs"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj"><i class='fab fa-facebook'></i> AWS Study Group - FB Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/6-enabling-batch-processing-in-lambda-with-sqs/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/6-enabling-batch-processing-in-lambda-with-sqs/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830891&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>26-11-2023</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng</a>
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/'>Event-Driven Architecture with SNS, SQS, S3, API Gateway and Lambda</a> > Routing API với Kong Gateway
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#tổng-quan">Tổng quan</a></li>
        <li><a href="#các-bước-thực-hiện">Các bước thực hiện</a></li>
        <li><a href="#tạo-service">Tạo service</a></li>
        <li><a href="#tạo-route">Tạo route</a></li>
        <li><a href="#tạo-jwt-plugin">Tạo JWT plugin</a></li>
        <li><a href="#tạo-pre-function-plugin">Tạo Pre function plugin</a></li>
        <li><a href="#tổng-kết">Tổng kết</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Routing API với Kong Gateway
            </h1>
          

        



	<p><strong>Nội dung:</strong></p>
<ul>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#tổng-quan">Tổng quan</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#các-bước-thực-hiện">Các bước thực hiện</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#tạo-service">Tạo service</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#tạo-route">Tạo route</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#tạo-jwt-plugin">Tạo JWT plugin</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#tạo-pre-function-plugin">Tạo Pre function plugin</a></li>
<li><a href="/6-enabling-batch-processing-in-lambda-with-sqs/#-tổng-kết">Tổng kết</a></li>
</ul>
<h3 id="tổng-quan">Tổng quan</h3>
<p>Trong phần này chúng ta sẽ thực hiện 1 số api để định tuyến API với mục đích là để cho máy khách có thể gọi API tới các dịch vụ của chúng ta mà sẽ không gọi trực tiếp đến các dịch vụ nằm trong Private Applicaton Subnet. Đây cũng là 1 thiết kế phổ biến trong kiến trúc microservices.</p>
<hr>
<h3 id="các-bước-thực-hiện">Các bước thực hiện</h3>
<p>Để máy khách có thể gọi tới 1 api của ứng dụng backend của chúng ta thì chúng ta sẽ thực hiện những bước sau đây:</p>
<ol>
<li>Tạo service</li>
<li>Tao route</li>
</ol>
<p>Ngoài ra đối với những API cần xác thực JWT thì chúng ta sẽ tạo <strong>JWT plugin</strong> cho route này hay kiểm tra 1 số thông tin từ Token JWT như kiểm tra Role có phù hợp với hành động này hay không thì chúng ta sẽ tạo <strong>Pre-function</strong>.</p>
<h3 id="tạo-service">Tạo service</h3>
<ol>
<li>Chúng ta sẽ vào <strong>Post man</strong> và thực hiện API để tạo service</li>
<li>Chúng ta sẽ gọi api http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/services với phương thức <strong>POST</strong> (Tôi khuyên là chúng ta nên cấu hình <strong>Security group</strong> của <strong>EC2</strong> đang host <strong>Kong gateway</strong> được truy cập vào cổng 8001 với 1 số ip nhất định như chinh ip của máy mình):</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;&lt;NAME_OF_SERVICE&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;host&#34;</span>: <span style="color:#e6db74">&#34;&lt;PRIVATE_IP_OF_SERVICE&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#e6db74">&#34;&lt;PORT_OF_SERVICE&gt;&#34;</span>, <span style="color:#75715e">// Chúng ta sẽ sử dụng kiểu số ở đây
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;PATH_OF_API&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;retries&#34;</span>: <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;connect_timeout&#34;</span>: <span style="color:#ae81ff">60000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;write_timeout&#34;</span>: <span style="color:#ae81ff">60000</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;read_timeout&#34;</span>: <span style="color:#ae81ff">60000</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h3 id="tạo-route">Tạo route</h3>
<ol>
<li>Chúng ta sẽ vào <strong>Post man</strong> và thực hiện API để tạo service</li>
<li>Chúng ta sẽ gọi api http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/routes với phương thức <strong>POST</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;&lt;NAME_OF_ROUTE&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;service&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;&lt;NAME_OF_SERVICE&gt;&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;protocols&#34;</span>: [<span style="color:#e6db74">&#34;http&#34;</span>], <span style="color:#75715e">// Chúng ta có thể chọn nhiều protocols khác như http, https, gRPC,...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;methods&#34;</span>: [<span style="color:#e6db74">&#34;GET&#34;</span>], <span style="color:#75715e">// Chúng ta có thể thêm nhiều methods khác như GET, POST, PATHC,...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;paths&#34;</span>: [<span style="color:#e6db74">&#34;&lt;PATH_OF_API_THAT_WE_WANT_CLIENT_USE&gt;&#34;</span>],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;strip_path&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;preserve_host&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;request_buffering&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;response_buffering&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;https_redirect_status_code&#34;</span>: <span style="color:#ae81ff">426</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;regex_priority&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;path_handling&#34;</span>: <span style="color:#e6db74">&#34;v0&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h3 id="tạo-jwt-plugin">Tạo JWT plugin</h3>
<ol>
<li>Trước khi tạo JWT thì chúng ta sẽ tạo 1 <strong>Consummer</strong> trước.</li>
</ol>
<p><strong>Consummer là gì?</strong></p>
<p>Là đối tượng đại diện cho client truy cập API, như:</p>
<ul>
<li>Ứng dụng di động.</li>
<li>Frontend web.</li>
<li>Đối tác (partner system).</li>
<li>Một người dùng cụ thể.</li>
</ul>
<ol start="2">
<li>Tạo <strong>Consummer</strong> với API http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/consumers với phương <strong>POST</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;jwt&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;custom_id&#34;</span>: <span style="color:#e6db74">&#34;f0a221b9-d74f-44ac-93b6-50c8fd4259a7&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="3">
<li>Tạo <strong>JWT Plugin</strong> với API http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/routes/&lt;ID_OF_ROUTE&gt;/plugins với phương thức <strong>POST</strong>. Và để lấy <strong>&lt;ID_OF_ROUTE&gt;</strong> chúng ta sẽ thực hiện API http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/routes với phương thức <strong>GET</strong>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;jwt&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;config&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;run_on_preflight&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;secret_is_base64&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;key_claim_name&#34;</span>: <span style="color:#e6db74">&#34;iss&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;claims_to_verify&#34;</span>: [<span style="color:#e6db74">&#34;exp&#34;</span>],
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;anonymous&#34;</span>: <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;maximum_expiration&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;header_names&#34;</span>: [<span style="color:#e6db74">&#34;authorization&#34;</span>]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;enabled&#34;</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h3 id="tạo-pre-function-plugin">Tạo Pre function plugin</h3>
<ol>
<li>Chúng ta sẽ thực hiện API http://&lt;PUBLIC_IP_OF_KONG_GATEWAY&gt;:8001/routes/&lt;ID_OF_ROUTE&gt;/plugins.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;pre-function&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;config&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;access&#34;</span>: [
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;-- Get JWT token from header Authorization\nlocal auth_header = kong.request.get_header(\&#34;Authorization\&#34;)\nif not auth_header then\n  return kong.response.exit(401, { message = \&#34;missing Authorization header\&#34; })\nend\n\n-- Get token from \&#34;Bearer &lt;token&gt;\&#34;\nlocal token = auth_header:match(\&#34;^Bearer%s+(.+)$\&#34;)\nif not token then\n  return kong.response.exit(401, { message = \&#34;invalid Token format\&#34; })\nend\n\n-- Split token into 3 parts: header.payload.signature\nlocal token_parts = {}\nfor part in token:gmatch(\&#34;[^.]+\&#34;) do\n  table.insert(token_parts, part)\nend\n\nif #token_parts ~= 3 then\n  return kong.response.exit(401, { message = \&#34;invalid JWT token structure\&#34; })\nend\n\n-- Decode payload (middle part of JWT)\nlocal payload_str = ngx.decode_base64(token_parts[2])\nif not payload_str then\n  return kong.response.exit(401, { message = \&#34;failed to decode JWT payload\&#34; })\nend\n\n-- Extract \&#34;role\&#34; from JSON payload\nlocal role = payload_str:match(&#39;\&#34;role\&#34;%s*:%s*\&#34;([^\&#34;]+)\&#34;&#39;)\nif not role then\n  return kong.response.exit(403, { message = \&#34;missing role in token\&#34; })\nend\n\n-- Check role, only allow customer\nif role ~= \&#34;customer\&#34; then\n  return kong.response.exit(403, { message = \&#34;access denied: requires customer role\&#34; })\nend\n\nreturn&#34;</span>
</span></span><span style="display:flex;"><span>    ] <span style="color:#75715e">// Đây là code viết bằng lua và field access là nơi chúng ta sẽ đặt những code lua cho những mục đích kiểm tra của chúng ta. Và code trên kiểm tra Token JWT có chứa role là customer hay không và gán nó vòa Header của APi.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h3 id="tổng-kết">Tổng kết</h3>
<p>Trong phần này, chúng ta đã tìm hiểu cách sử dụng Kong Gateway để định tuyến và bảo vệ API trong môi trường kiến trúc microservices, cụ thể:</p>
<ul>
<li>Tạo Service: khai báo dịch vụ backend thực tế mà Kong sẽ định tuyến đến.</li>
<li>Tạo Route: cấu hình đường dẫn API mà client sẽ gọi, và ánh xạ nó đến service tương ứng.</li>
<li>Tạo Consumer: đại diện cho client hoặc hệ thống sử dụng API, dùng để gắn thông tin xác thực.</li>
<li>Cấu hình JWT Plugin: đảm bảo chỉ client có JWT hợp lệ mới có thể truy cập API, giúp tăng cường bảo mật.</li>
<li>Cấu hình Pre-function Plugin: viết logic Lua tùy chỉnh để kiểm tra thêm thông tin trong JWT (ví dụ: kiểm tra quyền truy cập thông qua trường role trong payload).</li>
</ul>
<p>Những bước này giúp đảm bảo rằng:</p>
<ul>
<li>Hệ thống của bạn được định tuyến hợp lý.</li>
<li>Các dịch vụ backend nằm trong Private Subnet vẫn có thể được truy cập một cách an toàn và kiểm soát được thông qua Kong Gateway.
-Bạn có thể dễ dàng kiểm soát, giới hạn và giám sát các request đến hệ thống.</li>
</ul>
<p>👉 Đây là cách tiếp cận chuẩn và phổ biến trong việc triển khai các API Gateway cho hệ thống microservices hiện đại.</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/5-creating-resources-at-pas/" title="Tạo các tài nguyên ở Private Application Subnet"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/7-setting-up-monitoring-and-logging-with-cloudwatch/" title="Monitoring and Observability with Amazon CloudWatch" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1753536349"></script>
    <script src="/js/perfect-scrollbar.min.js?1753536349"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1753536349"></script>
    <script src="/js/jquery.sticky.js?1753536349"></script>
    <script src="/js/featherlight.min.js?1753536349"></script>
    <script src="/js/highlight.pack.js?1753536349"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1753536349"></script>
    <script src="/js/learn.js?1753536349"></script>
    <script src="/js/hugo-learn.js?1753536349"></script>

    <link href="/mermaid/mermaid.css?1753536349" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1753536349"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
